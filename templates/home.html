<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>

    <div class="container-fluid h-100" style="padding: 120px 0;">
        <div class='row py-3 h-100'>
            <div class="col-8">
                <div id="video-container" class="video-container m-auto d-block position-relative" style="">
                    <div id="status-message" class="status-idle">Camera ready. Click a button to start.</div>
                    <video id="camera-video" class="mx-auto d-block" autoplay playsinline></video>
                </div>
            </div>

            <div class="col-3">
                <div class="sidebar-component d-flex flex-column justify-content-between h-100">
                    <div class="clock-component">
                        <div class="company-logo row align-items-center">
                            <div class="company-img col-3">
                                <img src="{{ url_for('static', filename='company-log.jpeg') }}" alt="Logo">
                            </div>
                            <div class="company-title col-9">
                                <h1 class="title">Sath Gym</h1>
                            </div>
                        </div>
                        <div class="clock-container">
                            <div class="time" id="clock">00:00:00</div>
                            <div class="date" id="date">{{ datetoday2 }}</div>
                        </div>
                    </div>

                    <div class="prc-card" id="prc-card">

                        <div class="prc-progress-container">
                            <div class="prc-progress-header">
                                <span class="prc-progress-label">Auto-closing</span>
                                <span class="prc-timer" id="prc-timer">10s</span>
                            </div>
                                <div class="prc-progress-bar">
                                <div class="prc-progress-fill" id="prc-progress-fill"></div>
                            </div>
                        </div>
                        <!-- Profile Header -->
                        <div class="prc-profile-header">
                            <div class="prc-avatar">JD</div>
                            <div class="prc-profile-info">
                                <div class="prc-profile-name">John Doe</div>
                                <div class="prc-member-since">Member since Jan 2024</div>
                            </div>
                            <!-- <div class="prc-premium-badge">Premium</div> -->
                        </div>

                        <!-- Subscription Alert -->
                        <div class="prc-alert d-none">
                            <div class="prc-alert-icon">âš </div>
                            <div class="prc-alert-content">
                                <div class="prc-alert-title">Subscription Expiring</div>
                                <div class="prc-alert-text">Your membership expires in <strong>5 days</strong>. Renew to continue access.</div>
                            </div>
                        </div>

                        <!-- Stats Grid -->
                        <div class="prc-stats-grid d-none">
                            <div class="prc-stat-card">
                                <div class="prc-stat-value">47</div>
                                <div class="prc-stat-label">Visits this month</div>
                            </div>
                            <div class="prc-stat-card">
                                <div class="prc-stat-value">12</div>
                                <div class="prc-stat-label">Day streak ðŸ”¥</div>
                            </div>
                        </div>
                    </div>

                    <div id="action-component">

                        {% if register %}
                            <form id="add-user-form" onsubmit="startAddUser(event)">
                                <input type="text" id="newuserid" name='newuserid' value="{{ register }}" class="d-none" required>
                                <button id="add-user-btn" type='submit' class='btn btn-primary'>
                                    Register Face
                                </button>
                            </form>
                        {% else %}
                            <button id="attendance-btn" type='button' class='btn btn-primary' onclick="startAttendance()">Check-in</button>
                        {% endif %}
                    </div>
                </div>
            <!-- <div id="status-message" class="status-idle">Camera ready. Click a button to start.</div> -->
            </div>
        </div>
    </div>

    <div class="row text-center">
        <div class="col">

        </div>
    </div>

    <script type="text/javascript">
        const video = document.getElementById('camera-video');
        const statusDiv = document.getElementById('status-message');
        const attendanceBtn = document.getElementById('attendance-btn');
        const addUserBtn = document.getElementById('add-user-btn');
        const progressBrd = document.getElementById('video-container');

        let stream = null;
        let captureInterval = null;
        let currentMode = null; // 'attendance' or 'adduser'

        // Clock
        const clockElement = document.getElementById('clock');
        function clock() {
            const now = new Date();
            let hours = now.getHours();
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12 || 12; // Convert to 12-hour format, 0 becomes 12
            clockElement.textContent = `${hours}:${minutes}:${seconds} ${ampm}`;
        }
        setInterval(clock, 1000);

        // Initialize camera
        async function initCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 640, height: 480, facingMode: 'user' }
                });
                video.srcObject = stream;
            } catch (err) {
                console.error('Camera error:', err);
            }
        }

        function updateStatus(message, type) {
            statusDiv.textContent = message;
            statusDiv.className = 'status-' + type;
        }

        function setButtonsDisabled(disabled) {
            attendanceBtn.disabled = disabled;
            addUserBtn.disabled = disabled;
        }

        async function replaceCard(customer_number) {
            try {
                const response = await fetch(`/members/${customer_number}`);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log(data);

                // Update profile name
                const profileName = document.querySelector('.prc-profile-name');
                if (profileName && data.fullname) {
                    profileName.textContent = data.fullname;
                }

                // Update avatar (initials)
                const avatar = document.querySelector('.prc-avatar');
                if (avatar && data.nickname) {
                    avatar.textContent = data.nickname;
                }

                // Update member since date
                const memberSince = document.querySelector('.prc-member-since');
                if (memberSince && data.created_at) {
                    const date = new Date(data.created_at);
                    const options = { year: 'numeric', month: 'short' };
                    const formattedDate = date.toLocaleDateString('en-US', options);
                    memberSince.textContent = `Member since ${formattedDate}`;
                } else if (memberSince && data.member_since) {
                    memberSince.textContent = `Member since ${data.member_since}`;
                }

                // Get the card element
                const card = document.getElementById('prc-card');

                // Show the card (in case it was hidden)
                if (card) {
                    card.style.display = 'block';
                    card.classList.remove('prc-fade-out');
                }

                // Start countdown and refresh page after it completes
                initCardCountdown('prc-card', 7);

                // Refresh page after countdown duration + animation time
                setTimeout(() => {
                    location.reload();
                }, 10500); // 10 seconds countdown + 500ms fade-out animation

            } catch (error) {
                console.error('Error fetching member data:', error);
            }
        }
        // Capture frame from video
        function captureFrame() {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            return canvas.toDataURL('image/jpeg', 0.8);
        }

        // Start attendance mode
        async function startAttendance() {
            const btnWrapper = document.getElementById('action-component');

            try {
                const response = await fetch('/start');
                const data = await response.json();

                if (data.error) {
                    updateStatus(data.error, 'error');
                    return;
                }
                btnWrapper.remove();
                currentMode = 'attendance';
                updateStatus('Look at the camera for attendance...', 'detecting');

                // Start sending frames
                captureInterval = setInterval(async () => {
                    const frame = captureFrame();
                    try {
                        const res = await fetch('/process_frame', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ image: frame })
                        });
                        const result = await res.json();
                        if (result.status === 'completed') {
                            stopCapture();
                            updateStatus(result.message, 'completed');
                            replaceCard(result.person)
                        } else if (result.status === 'detecting') {
                            updateStatus(result.message, 'detecting');
                        } else if (result.status === 'no_face') {
                            updateStatus('No face detected. Please look at the camera.', 'idle');
                        } else if (result.status === 'idle') {
                            stopCapture();
                        }
                    } catch (err) {
                        console.error('Frame processing error:', err);
                    }
                }, 200); // Send frame every 200ms

            } catch (err) {
                console.error('Start attendance error:', err);
                updateStatus('Error starting attendance mode.', 'error');
            }


        }

        // Start add user mode
        async function startAddUser(event) {
            event.preventDefault();

            const userId = document.getElementById('newuserid').value;
            if (!userId) {
                updateStatus('Please enter a user ID.', 'error');
                return;
            }

            try {
                const formData = new FormData();
                formData.append('newuserid', userId);

                const response = await fetch('/add', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (data.error) {
                    return;
                }

                currentMode = 'adduser';

                // Start sending frames for face capture
                captureInterval = setInterval(async () => {
                    const frame = captureFrame();
                    try {
                        const res = await fetch('/add_frame', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ image: frame })
                        });
                        const result = await res.json();

                        if (result.status === 'completed') {
                            updateStatus(result.message, 'completed');
                            stopCapture();
                            setTimeout(() => location.replace('/'), 2000);
                        } else if (result.status === 'capturing') {
                            updateStatus(result.message, 'capturing');
                        } else if (result.status === 'idle') {
                            stopCapture();
                        }
                    } catch (err) {
                        console.error('Frame processing error:', err);
                    }
                }, 100); // Send frame every 100ms for faster capture

            } catch (err) {
                console.error('Start add user error:', err);
            }
        }

        // Stop capture
        async function stopCapture() {
            if (captureInterval) {
                clearInterval(captureInterval);
                captureInterval = null;
            }

            try {
                await fetch('/stop');
            } catch (err) {
                console.error('Stop error:', err);
            }

            currentMode = null;
        }

        function initCardCountdown(cardId, duration = 10) {
            const card = document.getElementById(cardId);
            const timer = document.getElementById('prc-timer');
            const progressFill = document.getElementById('prc-progress-fill');

            if (!card) return;

            let timeLeft = duration;
            const totalTime = duration;

            const interval = setInterval(() => {
                timeLeft -= 0.1;

                // Update timer text
                timer.textContent = `${Math.ceil(timeLeft)}s`;

                // Update progress bar
                const percentage = (timeLeft / totalTime) * 100;
                progressFill.style.width = `${percentage}%`;

                // When countdown ends
                if (timeLeft <= 0) {
                clearInterval(interval);
                timer.textContent = '0s';
                progressFill.style.width = '0%';

                // Add fade-out class
                card.classList.add('prc-fade-out');

                // Remove element after animation
                setTimeout(() => {
                    card.remove();
                }, 500);
                }
            }, 100);

            return interval;
        }

        // Hide card initially on page load
        document.addEventListener('DOMContentLoaded', () => {
            const card = document.getElementById('prc-card');
            if (card) {
                card.style.display = 'none';
            }
        });

        // Initialize on page load
        window.onload = initCamera;

    </script>
</body>

</html>
