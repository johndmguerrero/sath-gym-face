<!doctype html>
<html lang="en">

<style type='text/css'>
    * {
        padding: 0;
        margin: 0;
        font-family: 'Segoe UI', Tahoma;
    }

    p {
        text-align: center;
        text-decoration: none;
        text-transform: uppercase;
    }

    body {
        background-image: url('/static/background.jpg');
        background-size: cover;
        font-family: Snell Roundhand, cursive;
        margin-top: 40px;
        height: 100vh;
        padding: 0;
        margin: 0;
    }

    h6 {
        font-family: Snell Roundhand, cursive;
    }

    table {
        border: 1px;
        font-family: Snell Roundhand, cursive;
        border-collapse: collapse;
        width: 86%;
        margin: auto;
    }

    td,
    th {
        border: 1px solid black !important;
        font-family: Snell Roundhand, cursive;
        padding: 5px;
    }

    tr:nth-child(even) {
        background-color: #dddddd;
    }

    #status-message {
        font-size: 18px;
        font-weight: bold;
        padding: 10px;
        margin: 10px auto;
        max-width: 640px;
        border-radius: 8px;
        text-align: center;
    }

    .status-idle { background-color: #e0e0e0; color: #333; }
    .status-detecting { background-color: #fff3cd; color: #856404; }
    .status-completed { background-color: #d4edda; color: #155724; }
    .status-error { background-color: #f8d7da; color: #721c24; }
    .status-capturing { background-color: #cce5ff; color: #004085; }

    #video-container {
        position: relative;
        width: 640px;
        margin: 0 auto;
    }

    #camera-video {
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    .btn-stop {
        background-color: #dc3545;
        color: white;
        border: none;
        padding: 10px 30px;
        font-size: 18px;
        border-radius: 8px;
        cursor: pointer;
        margin-top: 10px;
    }

    .btn-stop:hover {
        background-color: #c82333;
    }
</style>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
    <title>Intelligent Attendance System Utilizing Facial Recognition Technology</title>
</head>

<body>
    <div class='mt-3 text-center'>
        <div id="video-container">
            <video id="camera-video" width="640" height="480" autoplay playsinline></video>
        </div>
        <div id="status-message" class="status-idle">Camera ready. Click a button to start.</div>
        <button id="stop-btn" class="btn-stop" style="display: none;" onclick="stopCapture()">Stop</button>
    </div>

    <div class='mt-3 text-center'>
        <h3 style="font-size: 22px;color:#0b4c61;">{{ datetoday2 }} | <span id="clock"></span></h3>
    </div>

    {% if mess %}
    <p class="text-center" style="color: red;font-size: 20px;">{{ mess }}</p>
    {% endif %}

    <div class="row text-center" style="padding: 20px;margin: 20px;">
        <div class="col"
            style="border-radius: 20px;padding: 0px;background-color:rgba(211, 211, 211, 0.911);margin:0px 10px 10px 10px;min-height: 400px;">
            <h2 style="border-radius: 20px 20px 0px 0px;background-color: #0b4c61;color: white;padding: 10px;">Today's
                Attendance <i class="material-icons">assignment</i></h2>
            <button id="attendance-btn"
                style="font-size: 24px;font-weight: bold;border-radius: 10px;width:490px;padding: 10px;margin-top: 30px;margin-bottom: 30px;"
                type='button' class='btn btn-primary' onclick="startAttendance()">Take Attendance <i
                    class="material-icons">beenhere</i></button>
        </div>

        <div class="col"
            style="border-radius: 20px;padding: 0px;background-color:rgba(211, 211, 211, 0.911);margin:0px 10px 10px 10px;height: 400px;">
            <form id="add-user-form" onsubmit="startAddUser(event)">
                <h2 style="border-radius: 20px 20px 0px 0px;background-color: #0b4c61;color: white;padding: 10px;">Add
                    New User <i class="material-icons">control_point_duplicate</i></h2>
                <label style="font-size: 20px;"><b>Enter New User Name*</b></label>
                <br>
                <input type="text" id="newusername" name='newusername'
                    style="font-size: 20px;margin-top:10px;margin-bottom:10px;" required>
                <br>
                <label style="font-size: 20px;"><b>Enter New User Id*</b></label>
                <br>
                <input type="text" id="newuserid" name='newuserid'
                    style="font-size: 20px;margin-top:10px;margin-bottom:10px;" required>
                <br>
                <button id="add-user-btn" style="width: 232px;margin-top: 20px;font-size: 20px;" type='submit' class='btn btn-dark'>Add
                    New User
                </button>
                <br>
                <h5 style="padding: 25px;"><i>Total Users in Database: {{totalreg}}</i></h5>
            </form>
        </div>
    </div>

    <script type="text/javascript">
        const video = document.getElementById('camera-video');
        const statusDiv = document.getElementById('status-message');
        const stopBtn = document.getElementById('stop-btn');
        const attendanceBtn = document.getElementById('attendance-btn');
        const addUserBtn = document.getElementById('add-user-btn');

        let stream = null;
        let captureInterval = null;
        let currentMode = null; // 'attendance' or 'adduser'

        // Clock
        const clockElement = document.getElementById('clock');
        function clock() {
            clockElement.textContent = new Date().toString().slice(15, 24);
        }
        setInterval(clock, 1000);

        // Initialize camera
        async function initCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 640, height: 480, facingMode: 'user' }
                });
                video.srcObject = stream;
                updateStatus('Camera ready. Click a button to start.', 'idle');
            } catch (err) {
                console.error('Camera error:', err);
                updateStatus('Camera access denied. Please allow camera access.', 'error');
            }
        }

        function updateStatus(message, type) {
            statusDiv.textContent = message;
            statusDiv.className = 'status-' + type;
        }

        function setButtonsDisabled(disabled) {
            attendanceBtn.disabled = disabled;
            addUserBtn.disabled = disabled;
            stopBtn.style.display = disabled ? 'inline-block' : 'none';
        }

        // Capture frame from video
        function captureFrame() {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            return canvas.toDataURL('image/jpeg', 0.8);
        }

        // Start attendance mode
        async function startAttendance() {
            try {
                const response = await fetch('/start');
                const data = await response.json();

                if (data.error) {
                    updateStatus(data.error, 'error');
                    return;
                }

                currentMode = 'attendance';
                setButtonsDisabled(true);
                updateStatus('Look at the camera for attendance...', 'detecting');

                // Start sending frames
                captureInterval = setInterval(async () => {
                    const frame = captureFrame();
                    try {
                        const res = await fetch('/process_frame', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ image: frame })
                        });
                        const result = await res.json();

                        if (result.status === 'completed') {
                            updateStatus(result.message, 'completed');
                            stopCapture();
                            setTimeout(() => location.reload(), 2000);
                        } else if (result.status === 'detecting') {
                            updateStatus(result.message, 'detecting');
                        } else if (result.status === 'no_face') {
                            updateStatus('No face detected. Please look at the camera.', 'idle');
                        } else if (result.status === 'idle') {
                            stopCapture();
                        }
                    } catch (err) {
                        console.error('Frame processing error:', err);
                    }
                }, 200); // Send frame every 200ms

            } catch (err) {
                console.error('Start attendance error:', err);
                updateStatus('Error starting attendance mode.', 'error');
            }
        }

        // Start add user mode
        async function startAddUser(event) {
            event.preventDefault();

            const userId = document.getElementById('newuserid').value;
            if (!userId) {
                updateStatus('Please enter a user ID.', 'error');
                return;
            }

            try {
                const formData = new FormData();
                formData.append('newuserid', userId);

                const response = await fetch('/add', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (data.error) {
                    updateStatus(data.error, 'error');
                    return;
                }

                currentMode = 'adduser';
                setButtonsDisabled(true);
                updateStatus(data.message, 'capturing');

                // Start sending frames for face capture
                captureInterval = setInterval(async () => {
                    const frame = captureFrame();
                    try {
                        const res = await fetch('/add_frame', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ image: frame })
                        });
                        const result = await res.json();

                        if (result.status === 'completed') {
                            updateStatus(result.message, 'completed');
                            stopCapture();
                            setTimeout(() => location.reload(), 2000);
                        } else if (result.status === 'capturing') {
                            updateStatus(result.message, 'capturing');
                        } else if (result.status === 'idle') {
                            stopCapture();
                        }
                    } catch (err) {
                        console.error('Frame processing error:', err);
                    }
                }, 100); // Send frame every 100ms for faster capture

            } catch (err) {
                console.error('Start add user error:', err);
                updateStatus('Error starting add user mode.', 'error');
            }
        }

        // Stop capture
        async function stopCapture() {
            if (captureInterval) {
                clearInterval(captureInterval);
                captureInterval = null;
            }

            try {
                await fetch('/stop');
            } catch (err) {
                console.error('Stop error:', err);
            }

            currentMode = null;
            setButtonsDisabled(false);
            updateStatus('Camera ready. Click a button to start.', 'idle');
        }

        // Initialize on page load
        window.onload = initCamera;
    </script>
    <p>all rights reserved</p>
</body>

</html>
